<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>The Forex Network</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* Design kept as requested */
body { margin:0; padding:0; font-family:'Poppins',sans-serif; background: linear-gradient(200deg,#ff5f6d,#ffc371); color:#333; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; overflow-y:auto; scroll-behavior:smooth;}
.container { width:100%; max-width:520px; background:rgba(255,255,255,0.96); border-radius:18px; box-shadow:0 8px 50px rgba(0,0,0,0.15); padding:26px 20px 140px 20px; backdrop-filter:blur(8px); margin:60px auto 80px auto; position:relative;}
.floating-logo { position:fixed; top:8px; left:50%; transform:translateX(-50%); background:white; border-radius:50%; box-shadow:0 4px 15px rgba(0,0,0,0.18); padding:8px; z-index:1000;}
.floating-logo img { width:70px; height:70px; border-radius:50%; object-fit:cover; }
h1 { font-size:24px; background: linear-gradient(90deg,#ff5f6d,#ffc371); -webkit-background-clip:text; color:transparent; margin-bottom:6px; text-align:center; }
.topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:12px; }
.user-head { display:flex; align-items:center; gap:12px; }
.user-pic { width:56px; height:56px; border-radius:50%; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
.user-pic img { width:100%; height:100%; object-fit:cover; display:block; }
.small-menu { display:none; } /* Completely hidden as requested */
.hidden { display:none; }
input,select,button,textarea { width:100%; padding:10px; margin:8px 0; border-radius:12px; border:1px solid #ccc; box-sizing:border-box; font-size:15px; }
input:focus, select:focus, textarea:focus { border-color:#e65100; box-shadow:0 0 6px rgba(230,81,0,0.18); outline:none; }
.balance-card { background: linear-gradient(90deg,#ff5f6d,#ffc371); padding:14px; border-radius:14px; text-align:center; font-size:18px; font-weight:700; color:#fff; margin:10px 0 10px; }
.notice-card { background:linear-gradient(90deg,#ff5f6d,#ffc371); padding:12px; border-radius:12px; margin-bottom:12px; color:white; font-weight:600; }
.task, .trans { border:1px solid #eee; padding:12px; border-radius:12px; background:#fff8e6; margin:10px 0; }
.task:hover, .trans:hover { background:#fff6e0; }
table { width:100%; border-collapse:collapse; font-size:14px; background:#fff; border-radius:10px; overflow:hidden; margin:10px 0; }
th, td { padding:8px; text-align:left; border-bottom:1px solid #f2f2f2; }
th { background:#ff5f6d; color:white; font-weight:700; }
tr:nth-child(even){ background:#fafafa; }
.action-btn { display:inline-block; margin:2px; padding:6px 10px; border:none; border-radius:8px; color:#fff; font-size:13px; font-weight:600; cursor:pointer; }
.approve { background:#4caf50; }
.reject { background:#e53935; }
.block, .unblock { background:#4caf50; }
.delete { background:#ff5252; }
.card { background:rgba(255,255,255,0.96); padding:14px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.06); margin-bottom:12px; }
#helpList, #adminHelpList { max-height:260px; overflow-y:auto; }
#signupDiv button{ background: linear-gradient(90deg,#ff416c,#ff4b2b); color:white; font-weight:700; border:none; padding:12px; border-radius:12px; }
#loginDiv button{ background: linear-gradient(90deg,#ff6a88,#ff4b2b); color:white; font-weight:700; border:none; padding:12px; border-radius:12px; }
@media(max-width:760px){ .small-menu button{ padding:8px; } .container{ padding:18px 16px 160px 16px; } h1{font-size:20px;} }
.small { font-size:13px; color:#555; }
.status-pill { display:inline-block; padding:6px 8px; border-radius:999px; font-weight:700; font-size:12px; color:#fff; }
.status-pending { background:#ffb74d; }
.status-approved { background:#4caf50; }
.status-rejected { background:#e53935; }
.muted { color:#666; font-size:13px; }
a { color: #d84315; text-decoration: none; font-weight:700; }
/* Bottom nav */
.bottom-nav { position:fixed; left:50%; transform:translateX(-50%); bottom:0; width:100%; max-width:520px; display:flex; justify-content:space-around; gap:4px; padding:8px 0; background:rgba(255,255,255,0.96); backdrop-filter:blur(8px); box-shadow:0 -4px 20px rgba(0,0,0,0.08); z-index:1200; }
.nav-btn { flex:1; margin:0 4px; padding:10px 6px; border-radius:12px; border:none; background:transparent; display:flex; flex-direction:column; align-items:center; justify-content:center; font-weight:600; cursor:pointer; font-size:14px; color:#666; transition:color 0.2s; }
.nav-btn span { font-size: 22px; margin-bottom: 2px; }
.nav-active { color:#ff5f6d; background:rgba(255,95,109,0.1); }
.nav-active span { color:#ff5f6d; }
.center-space { display:none; } /* Removed center space */
/* quick-actions replaced by a card on Home page */
.action-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:10px; }
.action-grid button { padding:12px 8px; border-radius:10px; border:none; background:linear-gradient(90deg,#ff5f6d10,#ffc37110); box-shadow:0 3px 10px rgba(0,0,0,0.06); font-weight:700; cursor:pointer; color:#d84315; }
.action-grid button span { display:block; font-size:20px; margin-bottom:4px; }
/* settings small button near wallet (removed as requested) */
.right-small { display:none; }
</style>

</head>
<body>
    <div class="floating-logo"><img src="logo.png" id="platformLogo" alt="Logo"></div>
    <div class="container" id="mainContainer">
        
        <h1>The Forex Network</h1>

        <!-- AUTH -->
        <div id="authDiv">
            <div id="signupDiv">
                <h2>Sign Up</h2>
                <input id="signupName" placeholder="Full name" />
                <input id="signupPhone" placeholder="Phone number" />
                <input id="signupPass" type="password" placeholder="Password" />
                <input id="signupRefCode" placeholder="Referral code (optional)" />
                <button onclick="signup()">Sign Up</button>
                <p class="muted">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
            </div>

            <div id="loginDiv" class="hidden">
                <h3>Login</h3>
                <input id="loginPhone" placeholder="Phone number" />
                <input id="loginPass" type="password" placeholder="Password" />
                <button onclick="login()">Login</button>
                <p class="muted">Don't have an account? <a href="#" onclick="showSignup()">Sign Up</a></p>
            </div>
        </div>

        <!-- USER DASHBOARD -->
        <div id="userDashboard" class="hidden">
            <div style="text-align:right;"><button id="logoutBtn" style="background:linear-gradient(90deg,#ff5f6d,#ffc371);color:#fff;padding:8px;border-radius:8px;border:none;" onclick="logout()">Logout</button></div>

            <!-- Top area: user pic + quick buttons (removed quick buttons) -->
            <div class="topbar">
                <div class="user-head">
                    <div class="user-pic" id="headerPicWrap"><img id="headerPic" src="logo.png" alt="pic"></div>
                    <div>
                        <div style="font-weight:800" id="userName">User</div>
                        <div class="small muted" id="userPhoneDisplay"></div>
                    </div>
                </div>
            </div>

            <div id="userNotice" class="notice-card hidden"></div>

            <!-- HOME -->
            <div id="home">
                <h2>Welcome back, <span id="homeName"></span></h2>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                        <div>
                            <div class="small muted">Today's Income</div>
                            <div style="font-size:20px; font-weight:800">‡ß≥ <span id="todayIncome">0.00</span></div>
                        </div>
                        <div>
                            <div class="small muted">Total Income</div>
                            <div style="font-size:20px; font-weight:800">‡ß≥ <span id="totalIncome">0.00</span></div>
                        </div>
                    </div>
                    <!-- Removed quick-actions from here -->
                </div>
                
                <!-- New Quick Access Card -->
                <div class="card">
                    <h4>Quick Access</h4>
                    <div class="action-grid">
                        <button onclick="showSection('plans')"><span>üìú</span> My Plan</button>
                        <button onclick="showSection('tasks')"><span>‚öíÔ∏è</span> My Work</button>
                        <button onclick="showSection('refer')"><span>üë•</span> My Team</button>
                    </div>
                </div>

                <p class="small">Complete tasks, earn money and grow your business efficiently.</p>
            </div>

            <!-- PLANS -->
            <div id="plans" class="hidden">
                <h2>Buy a Plan</h2>
                <div id="currentPlanInfo" class="card"></div>
                <div class="card"><h4>‡ß≥300 Plan</h4><p class="small">3 tasks/day ‚Ä¢ reward per task set by admin</p><button onclick="buyPlan(300)">Buy Now (‡ß≥300)</button></div>
                <div class="card"><h4>‡ß≥1000 Plan</h4><p class="small">10 tasks/day ‚Ä¢ reward per task set by admin</p><button onclick="buyPlan(1000)">Buy Now (‡ß≥1000)</button></div>
            </div>

            <!-- TASKS -->
            <div id="tasks" class="hidden"><h2>My Work</h2><div id="taskList"></div></div>

            <!-- WALLET (contains balance + deposit + withdraw + transactions) -->
            <div id="wallet" class="hidden">
                <h2>Wallet</h2>
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                    <div class="balance-card">Balance: ‡ß≥ <span id="userBalance">0.00</span></div>
                    <!-- Removed small settings button near wallet (on the right) -->
                </div>

                <div class="card">
                    <h4>Deposit</h4>
                    <h4 class="small">Mobile: Bkash / Nagad number: <b>01734625071</b></h4>
                    <select id="depositMethod"><option>Bkash</option><option>Nagad</option></select>
                    <input id="depositAmount" type="number" placeholder="Amount (300 or 1000 only)" />
                    <input id="depositCode" placeholder="Transaction code (from your mobile payment)" />
                    <button onclick="submitDeposit()">Send Deposit Request</button>
                    <p id="depositRule" class="small muted">‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ: ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (‡ß≥300 ‡¶¨‡¶æ ‡ß≥1000)‡•§</p>
                </div>

                <div class="card">
                    <h4>Withdraw</h4>
                    <select id="withdrawMethod"><option>Bkash</option><option>Nagad</option></select>
                    <input id="withdrawNumber" placeholder="Your mobile number" />
                    <input id="withdrawAmount" type="number" placeholder="Amount (minimum ‡ß≥1000)" />
                    <button onclick="submitWithdraw()">Request Withdraw</button>
                    <p id="withdrawNote" class="small muted">‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø: ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß´ ‡¶ú‡¶® ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶Ø‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶ï‡¶∞‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§</p>
                </div>

                <div class="card">
                    <h4>Recent Transactions</h4>
                    <div id="walletTxList"></div>
                </div>
            </div>

            <!-- SUPPORT -->
            <div id="support" class="hidden">
                <h2>Support Center</h2>
                <p class="small">Send a message to admin. Admin can reply from Admin Panel. Useful links below.</p>
                <input id="helpMessage" placeholder="Type your message" />
                <button onclick="sendHelp()">Send</button>
                <div id="helpList"></div>

                <div class="card">
                    <h4>Useful Links</h4>
                    <p>Income Review Group: <a id="reviewGroupLink" href="#" target="_blank">Visit Group</a></p>
                    <p>YouTube Channel: <a id="youtubeLink" href="#" target="_blank">Visit Channel</a></p>
                    <p>Admin Telegram: <a id="telegramLink" href="#" target="_blank">Message Admin</a></p>
                </div>
            </div>

            <!-- ACCOUNT / SETTINGS -->
            <div id="account" class="hidden">
                <h2>Account Settings</h2>

                <div class="card">
                    <h4>Profile Picture</h4>
                    <div style="display:flex; gap:12px; align-items:center;">
                        <div style="width:72px; height:72px; border-radius:50%; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,0.06);">
                            <img id="settingsPic" src="logo.png" style="width:100%;height:100%;object-fit:cover;">
                        </div>
                        <div style="flex:1">
                            <input id="profilePicInput" type="file" accept="image/*" />
                            <button onclick="changeProfilePic()">Upload & Save</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h4>Change name</h4>
                    <input id="changeNameInput" placeholder="Your name" />
                    <button onclick="changeName()">Save Name</button>
                </div>

                <div class="card">
                    <h4>Change password</h4>
                    <input id="oldPass" type="password" placeholder="Current password" />
                    <input id="newPass" type="password" placeholder="New password" />
                    <button onclick="changePassword()">Change Password</button>
                </div>
            </div>

            <!-- TRANSACTIONS / REFS kept (hidden by default) -->
            <div id="transactions" class="hidden"><h2>Transaction History</h2>
                <div class="card"><h4>Deposit History</h4><div id="depositHistory"></div></div>
                <div class="card"><h4>Withdraw History</h4><div id="withdrawHistory"></div></div>
                <div class="card"><h4>Plan Purchase History</h4><div id="planHistory"></div></div>
                <div class="card"><h4>Other Transactions</h4><div id="otherHistory"></div></div>
            </div>

            <div id="refer" class="hidden">
                <h2>My Team (Referrals)</h2>
                <div id="myReferLink" class="card"></div>
                <div id="referHistory" class="card"></div>
            </div>

        </div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" class="hidden">
            <h2>Admin Panel</h2>
            <div style="text-align:right;margin-bottom:10px;"><button style="background:#e53935;color:#fff;padding:8px;border-radius:8px;border:none;" onclick="logout()">Logout</button></div>

            <div class="menu" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                <button onclick="showAdminSection('adminTasks')">Tasks</button>
                <button onclick="showAdminSection('adminUsers')">Users</button>
                <button onclick="showAdminSection('adminDeposits')">Deposit Requests</button>
                <button onclick="showAdminSection('adminWithdraws')">Withdraw Requests</button>
                <button onclick="showAdminSection('adminHelp')">Support Desk</button>
                <button onclick="showAdminSection('adminNotice')">Send Notice</button>
                <button onclick="showAdminSection('adminLogo')">Change Logo</button>
            </div>

            <div id="adminNotice" class="hidden card">
                <h3>Send Notice to All Users</h3>
                <input id="noticeMessage" placeholder="Type your notice here (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)" />
                <button onclick="sendNotice()">Send Notice</button>
                <p class="small muted">‡¶®‡ßã‡¶ü‡¶ø‡¶∂‡¶ü‡¶ø ‡¶∏‡¶∞‡ßç‡¶¨‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶ï‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≠‡¶æ‡¶∑‡¶æ‡¶Ø‡¶º ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡•§</p>
            </div>

            <div id="adminLogo" class="hidden card">
                <h3>Change Logo</h3>
                <input id="logoInput" type="file" accept="image/*" /><button onclick="changeLogo()">Upload Logo</button>
            </div>

            <div id="adminTasks" class="hidden card">
                <h3>Manage Tasks (Add / Delete) + Set Reward</h3>
                <input id="taskTitle" placeholder="Task title" />
                <input id="taskLink" placeholder="Task link (https://...)" />
                <input id="taskReward" type="number" placeholder="Reward per task (‡ß≥) ‚Äî e.g. 10" />
                <button onclick="addTask()">Add Task</button>
                <div id="adminTaskList"></div>
            </div>

            <div id="adminUsers" class="hidden card">
                <h3>Users List</h3>
                <table id="usersTable"><thead><tr><th>Name</th><th>Phone</th><th>Balance</th><th>Password</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="adminDeposits" class="hidden card">
                <h3>Deposit Requests</h3>
                <table id="depositTable"><thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Code</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="adminWithdraws" class="hidden card">
                <h3>Withdraw Requests</h3>
                <table id="withdrawTable"><thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Number</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="adminHelp" class="hidden card">
                <h3>Support Desk</h3>
                <div id="adminHelpList"></div>
            </div>

        </div>

    </div>
    
    <!-- Bottom nav with Icons -->
    <div class="bottom-nav hidden" id="bottomNav">
        <button class="nav-btn nav-active" id="navHome" onclick="navTo('home', this)"><span>üè†</span> Home</button>
        <button class="nav-btn" id="navWallet" onclick="navTo('wallet', this)"><span>üí∞</span> Wallet</button>
        <button class="nav-btn" id="navAccount" onclick="navTo('account', this)"><span>‚öôÔ∏è</span> Settings</button>
        <button class="nav-btn" id="navSupport" onclick="navTo('support', this)"><span>üí¨</span> Support</button>
    </div>
    
<script>
/* ========== Data & constants (using localStorage as provided) ========== */
let users = JSON.parse(localStorage.getItem('users')) || [];
let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
let deposits = JSON.parse(localStorage.getItem('deposits')) || [];
let withdraws = JSON.parse(localStorage.getItem('withdraws')) || [];
let helps = JSON.parse(localStorage.getItem('helps')) || [];
let noticeText = localStorage.getItem('notice') || '';
let currentUser = null;

// admin credentials (change if you want)
const adminPhone = "01700000000";
const adminPass = "admin123";

const ONE_DAY_MS = 24 * 60 * 60 * 1000;
const MIN_WITHDRAW_AMOUNT = 1000;
const PLAN_AMOUNTS = [300, 1000]; // allowed deposit amounts (and plan amounts)
const PLAN_COOLDOWN_DAYS = 30; // cannot deposit if existing plan is younger than this

/* ========== helpers ========== */
function saveAll(){
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('tasks', JSON.stringify(tasks));
    localStorage.setItem('deposits', JSON.stringify(deposits));
    localStorage.setItem('withdraws', JSON.stringify(withdraws));
    localStorage.setItem('helps', JSON.stringify(helps));
}
function findUserIndexByPhone(phone){ return users.findIndex(u => u.phone === phone); }
function findUserByPhone(phone){ return users.find(u => u.phone === phone); }
function todayISO(){ return (new Date()).toISOString().split('T')[0]; }
function nowMs(){ return Date.now(); }
function generateId(prefix='id'){ return prefix + '_' + nowMs() + '_' + Math.floor(Math.random()*10000); }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"'`=\/]/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[ch]); }
function capitalize(s){ if(!s) return ''; return String(s).charAt(0).toUpperCase()+String(s).slice(1); }
function statusPill(status){
    status = (status||'').toString().toLowerCase();
    if(status==='approved') return '<span class="status-pill status-approved">Approved</span>';
    if(status==='rejected') return '<span class="status-pill status-rejected">Rejected</span>';
    return '<span class="status-pill status-pending">Pending</span>';
}

/* ====== Logo loader ====== */
function loadLogo(){ let logo = localStorage.getItem('platformLogo'); if(logo) { let el = document.getElementById('platformLogo'); if(el) el.src = logo; } }
function changeLogo(){
    let file = document.getElementById('logoInput').files[0];
    if(!file) return alert('Select an image first');
    let reader = new FileReader();
    reader.onload = function(e){
        localStorage.setItem('platformLogo', e.target.result);
        document.getElementById('platformLogo').src = e.target.result;
        saveAll();
        alert('Logo updated');
    };
    reader.readAsDataURL(file);
}
loadLogo();

/* ====== Persist current user between reloads ====== */
function setLoggedUser(phone){
    if(!phone) localStorage.removeItem('currentUserPhone');
    else localStorage.setItem('currentUserPhone', phone);
}
function clearLoggedUser(){
    localStorage.removeItem('currentUserPhone');
}
function restoreLoggedUser(){
    let phone = localStorage.getItem('currentUserPhone');
    if(!phone) return null;
    let u = findUserByPhone(phone);
    if(u) currentUser = u;
}
restoreLoggedUser();

/* control bottom nav visibility */
function setBottomNavVisible(visible){
    const el = document.getElementById('bottomNav');
    if(!el) return;
    if(visible) { el.classList.remove('hidden'); } else { el.classList.add('hidden'); }
}

/* ====== Auth UI ====== */
function showSignup(){ document.getElementById('signupDiv').classList.remove('hidden'); document.getElementById('loginDiv').classList.add('hidden'); }
function showLogin(){ document.getElementById('signupDiv').classList.add('hidden'); document.getElementById('loginDiv').classList.remove('hidden'); }
function logout(){
    currentUser = null;
    clearLoggedUser();
    document.getElementById('userDashboard').classList.add('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('authDiv').classList.remove('hidden');
    saveAll();
    // hide bottom nav on auth screens (as requested)
    setBottomNavVisible(false);
    // reset nav active
    navActiveClear();
    document.getElementById('navHome').classList.remove('nav-active');
}

/* ====== Signup / Login ====== */
function signup(){
    let name = document.getElementById('signupName').value.trim();
    let phone = document.getElementById('signupPhone').value.trim();
    let pass = document.getElementById('signupPass').value;
    let ref = document.getElementById('signupRefCode').value.trim();
    if(!name || !phone || !pass) return alert('Please fill required fields');
    if(users.find(u => u.phone === phone)) return alert('Phone already registered');
    users.push({
        name: name,
        phone: phone,
        pass: pass,
        balance: 0,
        plan: null,
        status: 'active',
        ref: ref || '',
        transactions: [],
        tasksDone: 0,
        completedTasks: [],
        firstWithdrawDone: false,
        pic: '' // user profile pic (dataURL)
    });
    saveAll();
    alert('Sign up done ‚Äî please login');
    showLogin();
}

function login(){
    let phone = document.getElementById('loginPhone').value.trim();
    let pass = document.getElementById('loginPass').value;
    if(phone === adminPhone && pass === adminPass){
        document.getElementById('authDiv').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        loadAdminTasks(); loadAdminUsers(); loadAdminDeposits(); loadAdminWithdraws(); loadAdminHelp();
        setLoggedUser(''); // admin not stored as normal user
        setBottomNavVisible(false); // admin UI has no bottom nav
        return;
    }
    let uIndex = findUserIndexByPhone(phone);
    if(uIndex === -1) return alert('Invalid credentials');
    let u = users[uIndex];
    if(u.pass !== pass) return alert('Invalid credentials');
    if(u.status !== 'active') return alert('Your account is blocked');
    currentUser = u;
    setLoggedUser(currentUser.phone);
    document.getElementById('userDashboard').classList.remove('hidden');
    document.getElementById('authDiv').classList.add('hidden');
    // show bottom nav after login
    setBottomNavVisible(true);
    // set home nav active
    navActiveClear();
    document.getElementById('navHome').classList.add('nav-active');
    updateDashboard();
}

/* ====== Dashboard UI & Nav ====== */
function navActiveClear(){
    document.getElementById('navHome').classList.remove('nav-active');
    document.getElementById('navWallet').classList.remove('nav-active');
    document.getElementById('navAccount').classList.remove('nav-active');
    document.getElementById('navSupport').classList.remove('nav-active');
}
function navTo(section, btnEl){
    navActiveClear();
    if(btnEl) btnEl.classList.add('nav-active');
    showSection(section);
    // ensure wallet updates if chosen
    if(section === 'wallet') {
        document.getElementById('userBalance').innerText = Number(currentUser.balance || 0).toFixed(2);
        loadWalletTxList();
    }
}
function updateDashboard(){
    if(!currentUser) return;
    document.getElementById('userName').innerText = currentUser.name;
    document.getElementById('homeName').innerText = currentUser.name;
    document.getElementById('userBalance').innerText = Number(currentUser.balance || 0).toFixed(2);
    document.getElementById('userPhoneDisplay').innerText = currentUser.phone;
    document.getElementById('myReferLink').innerHTML = '<b>Your referral code:</b> ' + escapeHtml(currentUser.phone);

    // profile pic
    let pic = currentUser.pic || localStorage.getItem('platformLogo') || 'logo.png';
    setHeaderPic(pic);

    // show notice if set
    document.getElementById('userNotice').classList.add('hidden');
    if(localStorage.getItem('notice')){
        document.getElementById('userNotice').classList.remove('hidden');
        document.getElementById('userNotice').innerText = localStorage.getItem('notice');
    }

    // set incomes
    setIncomes();

    // populate wallet tx list and other views
    loadTasks();
    loadTransactions();
    loadCurrentPlan();
    loadReferHistory();
    loadHelp();
    loadWalletTxList();

    // show home by default
    showSection('home');
}
function goHome(){ showSection('home'); }

// All sections are hidden/shown based on navigation to ensure only one is visible
function showSection(sec){
    // all possible sections
    let sections = ['home','plans','wallet','withdraw','deposit','transactions','refer','tasks','account','support'];
    sections.forEach(s => { let el=document.getElementById(s); if(el) el.classList.add('hidden'); });
    let el = document.getElementById(sec);
    if(el) el.classList.remove('hidden');

    // update some views on display
    if(sec === 'transactions') loadTransactions();
    if(sec === 'refer') loadReferHistory();
    if(sec === 'wallet') {
        if(currentUser) {
            document.getElementById('userBalance').innerText = Number(currentUser.balance || 0).toFixed(2);
            loadTransactions();
            loadWalletTxList();
        }
    }
}
function showAdminSection(sec){
    let sections = ['adminTasks','adminUsers','adminDeposits','adminWithdraws','adminHelp','adminNotice','adminLogo'];
    sections.forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(sec).classList.remove('hidden');
}

/* ====== compute incomes (today & total) ====== */
function parseTxDateISO(tx){
    if(!tx) return null;
    // prefer dateISO then date
    let iso = tx.dateISO || tx.date;
    if(!iso) return null;
    try {
        let d = new Date(iso);
        if(isNaN(d)) return null;
        return d.toISOString().split('T')[0];
    } catch(e){ return null; }
}
function setIncomes(){
    if(!currentUser) return;
    let today = todayISO();
    let total = 0;
    let todaySum = 0;
    (currentUser.transactions || []).forEach(t=>{
        let amt = Number(t.amount) || 0;
        if(amt > 0) total += amt;
        let txISO = parseTxDateISO(t);
        if(txISO === today && amt > 0) todaySum += amt;
    });
    document.getElementById('todayIncome').innerText = todaySum.toFixed(2);
    document.getElementById('totalIncome').innerText = total.toFixed(2);
}

/* ====== Profile picture update (user) ====== */
function setHeaderPic(dataUrl){
    let header = document.getElementById('headerPic');
    let settings = document.getElementById('settingsPic');
    if(header) header.src = dataUrl || 'logo.png';
    if(settings) settings.src = dataUrl || 'logo.png';
}
function changeProfilePic(){
    if(!currentUser) return alert('Login first');
    let file = document.getElementById('profilePicInput').files[0];
    if(!file) return alert('Select an image');
    let reader = new FileReader();
    reader.onload = function(e){
        let data = e.target.result;
        currentUser.pic = data;
        // persist user
        let idx = findUserIndexByPhone(currentUser.phone);
        if(idx !== -1){ users[idx] = currentUser; saveAll(); setLoggedUser(currentUser.phone); }
        setHeaderPic(data);
        alert('Profile picture updated');
    };
    reader.readAsDataURL(file);
}
function changeName(){
    if(!currentUser) return alert('Login first');
    let newName = document.getElementById('changeNameInput').value.trim();
    if(!newName) return alert('Enter a name');
    currentUser.name = newName;
    let idx = findUserIndexByPhone(currentUser.phone);
    if(idx !== -1){ users[idx] = currentUser; saveAll(); setLoggedUser(currentUser.phone); }
    updateDashboard();
    alert('Name updated');
}

/* ====== Password change (placeholder logic) ====== */
function changePassword(){
    if(!currentUser) return alert('Login first');
    let oldPass = document.getElementById('oldPass').value;
    let newPass = document.getElementById('newPass').value;
    if(currentUser.pass !== oldPass) return alert('Current password incorrect.');
    if(!newPass || newPass.length < 4) return alert('New password must be at least 4 characters.');

    currentUser.pass = newPass;
    let idx = findUserIndexByPhone(currentUser.phone);
    if(idx !== -1){ users[idx] = currentUser; saveAll(); setLoggedUser(currentUser.phone); }
    document.getElementById('oldPass').value = '';
    document.getElementById('newPass').value = '';
    alert('Password changed successfully.');
}

/* ====== Plans & buying ====== */
function buyPlan(amount){
    if(!currentUser) return alert('Please login first');
    if(currentUser.plan && currentUser.plan.dateMs){
        let days = Math.floor((nowMs() - currentUser.plan.dateMs) / (24*60*60*1000));
        if(days < PLAN_COOLDOWN_DAYS) return alert('You already have an active plan. You may get a new plan after '+ (PLAN_COOLDOWN_DAYS - days) +' day(s).');
    }
    if(currentUser.balance < amount) return alert('Insufficient balance. Deposit first (exactly 300 or 1000).');
    
    // Deduct balance
    currentUser.balance = Number((currentUser.balance - amount).toFixed(2));
    
    // Set plan
    currentUser.plan = { amount: amount, dateMs: nowMs(), tasksAllowed: (amount === 300 ? 3 : 10), lastResetISO: todayISO() };
    currentUser.tasksDone = 0;
    
    // Log transaction
    if(!currentUser.transactions) currentUser.transactions = [];
    currentUser.transactions.push({ type: 'Plan Purchase', amount: -amount, date: new Date().toLocaleString(), dateISO: new Date().toISOString(), note: amount + ' ‡ß≥ plan' });

    // Referral commission (20%)
    if(currentUser.ref){
        let refUser = findUserByPhone(currentUser.ref);
        if(refUser){
            let commission = Number((amount * 0.20).toFixed(2));
            refUser.balance = Number((refUser.balance + commission).toFixed(2));
            if(!refUser.transactions) refUser.transactions = [];
            refUser.transactions.push({ type: 'Referral Commission', amount: commission, date: new Date().toLocaleString(), dateISO: new Date().toISOString(), note: '20% from ' + currentUser.phone + ' plan' });
            let idx = findUserIndexByPhone(refUser.phone);
            if(idx !== -1) users[idx] = refUser;
        }
    }

    let idx = findUserIndexByPhone(currentUser.phone);
    if(idx !== -1) users[idx] = currentUser;
    saveAll();
    alert('Plan purchased successfully!');
    updateDashboard();
}

/* ====== Current plan info ====== */
function loadCurrentPlan(){
    let info = document.getElementById('currentPlanInfo');
    if(currentUser && currentUser.plan){
        let d = new Date(currentUser.plan.dateMs);
        info.innerHTML = 'Current Plan: ‡ß≥' + currentUser.plan.amount + ' ‚Äî bought on ' + d.toLocaleDateString() + ' ‚Ä¢ Tasks/day: ' + currentUser.plan.tasksAllowed;
    } else info.innerHTML = 'No active plan';
}

/* ====== Tasks (User side) ====== */
function cleanupOldTasks(){
    let now = nowMs();
    let originalLen = tasks.length;
    // Tasks older than 30 days are removed to avoid bloat
    tasks = tasks.filter(t => (now - (t.createdAtMs || nowMs())) < (30 * ONE_DAY_MS));
    if(tasks.length !== originalLen) saveAll();
}
function resetTasksIfNeeded(user){
    if(!user || !user.plan) return;
    let today = todayISO();
    if(user.plan.lastResetISO !== today){
        user.tasksDone = 0;
        user.plan.lastResetISO = today;
        let idx = findUserIndexByPhone(user.phone);
        if(idx !== -1){ users[idx] = user; saveAll(); }
    }
}
function loadTasks(){
    cleanupOldTasks(); saveAll();
    let html = '';
    if(!currentUser || !currentUser.plan){
        html = '<div class="card">If you want tasks, buy a plan (‡ß≥300 or ‡ß≥1000).</div>';
        document.getElementById('taskList').innerHTML = html; return;
    }

    // Reset tasks if date changed
    resetTasksIfNeeded(currentUser);

    const tasksAllowed = currentUser.plan.tasksAllowed || 0;
    const tasksDoneToday = currentUser.tasksDone || 0;
    const tasksRemaining = tasksAllowed - tasksDoneToday;
    const dailyReward = tasks.length > 0 ? Number(tasks[0].reward) : 0; // Assuming all tasks have same reward

    html += '<div class="card" style="margin-bottom:15px;">';
    html += '<h4>Daily Limit: <span style="color:#d84315;">' + tasksAllowed + '</span></h4>';
    html += '<p>Completed today: <b>' + tasksDoneToday + '</b> / Remaining: <b>' + tasksRemaining + '</b></p>';
    html += '<p class="small muted">Reward per task: ‡ß≥' + dailyReward.toFixed(2) + '</p>';
    html += '</div>';

    if (tasks.length === 0) {
        html += '<div class="card">No tasks available right now. Check back later.</div>';
    } else {
        // Show only as many tasks as the user has remaining in their daily limit
        const availableTasks = tasks.slice(0, tasksRemaining > 0 ? tasksRemaining : 0);

        availableTasks.forEach(task => {
            html += '<div class="task">';
            html += '<h4>' + escapeHtml(task.title) + '</h4>';
            html += '<p class="small muted">Reward: ‡ß≥' + dailyReward.toFixed(2) + '</p>';
            html += '<a href="' + escapeHtml(task.link) + '" target="_blank" class="action-btn approve" style="margin-right:8px;">Go To Link</a>';
            html += '<button class="action-btn reject" onclick="doTask(\'' + task.id + '\', ' + dailyReward + ')">Complete & Earn</button>';
            html += '</div>';
        });

        if (tasksRemaining <= 0) {
            html += '<div class="card" style="background:#f9f9f9; text-align:center;">You have reached your daily task limit.</div>';
        }
    }

    document.getElementById('taskList').innerHTML = html;
}

/* ====== Task Execution ====== */
function doTask(taskId, reward){
    if (!currentUser) return alert('Please login first');
    if (!currentUser.plan) return alert('Buy a plan to perform tasks.');

    resetTasksIfNeeded(currentUser);
    const tasksAllowed = currentUser.plan.tasksAllowed || 0;
    if (currentUser.tasksDone >= tasksAllowed) {
        return alert('You have reached your daily task limit of ' + tasksAllowed + ' tasks.');
    }

    currentUser.tasksDone++;
    currentUser.balance = Number((currentUser.balance + reward).toFixed(2));

    if (!currentUser.transactions) currentUser.transactions = [];
    currentUser.transactions.push({
        type: 'Task Income',
        amount: reward,
        date: new Date().toLocaleString(),
        dateISO: new Date().toISOString(),
        note: 'Task ID: ' + taskId
    });

    let idx = findUserIndexByPhone(currentUser.phone);
    if(idx !== -1) users[idx] = currentUser;
    saveAll();

    alert('Task completed successfully! You earned ‡ß≥' + reward.toFixed(2));

    updateDashboard();
    loadTasks();
}

/* ====== Deposit Submission (User) ====== */
function submitDeposit(){
    if(!currentUser) return alert('Please login first');
    let method = document.getElementById('depositMethod').value;
    let amount = Number(document.getElementById('depositAmount').value);
    let code = document.getElementById('depositCode').value.trim();

    if(!amount || !code) return alert('Fill all fields');
    if(!PLAN_AMOUNTS.includes(amount)) return alert('Deposit amount must be ‡ß≥300 or ‡ß≥1000.');

    // Check if a pending deposit already exists
    if(deposits.find(d => d.userPhone === currentUser.phone && d.status === 'pending')){
        return alert('You already have a pending deposit request.');
    }

    deposits.push({
        id: generateId('dep'),
        userPhone: currentUser.phone,
        amount: amount,
        method: method,
        code: code,
        status: 'pending',
        date: new Date().toLocaleString()
    });

    saveAll();
    alert('Deposit request submitted! Awaiting admin approval.');
    document.getElementById('depositAmount').value = '';
    document.getElementById('depositCode').value = '';
    loadTransactions(); // refresh history
}

/* ====== Withdraw Submission (User) ====== */
function submitWithdraw(){
    if(!currentUser) return alert('Please login first');
    let method = document.getElementById('withdrawMethod').value;
    let number = document.getElementById('withdrawNumber').value.trim();
    let amount = Number(document.getElementById('withdrawAmount').value);

    if(!amount || !number) return alert('Fill all fields');
    if(amount < MIN_WITHDRAW_AMOUNT) return alert('Minimum withdrawal amount is ‡ß≥' + MIN_WITHDRAW_AMOUNT + '.');
    if(amount > currentUser.balance) return alert('Insufficient balance.');

    // Check first withdraw requirement (5 referrers)
    if(!currentUser.firstWithdrawDone){
        let successfulRefs = users.filter(u => u.ref === currentUser.phone && u.plan).length;
        if(successfulRefs < 5) return alert('For the first withdrawal, you need at least 5 referred users who have bought a plan and worked. You currently have ' + successfulRefs + ' successful referrals.');
    }

    // Check if a pending withdraw already exists
    if(withdraws.find(w => w.userPhone === currentUser.phone && w.status === 'pending')){
        return alert('You already have a pending withdrawal request.');
    }

    withdraws.push({
        id: generateId('wdr'),
        userPhone: currentUser.phone,
        amount: amount,
        method: method,
        number: number,
        status: 'pending',
        date: new Date().toLocaleString()
    });

    saveAll();
    alert('Withdraw request submitted! Awaiting admin approval.');
    document.getElementById('withdrawNumber').value = '';
    document.getElementById('withdrawAmount').value = '';
    loadTransactions(); // refresh history
}

/* ====== Transaction history for user (Wallet) ====== */
function loadWalletTxList(){
    let list = document.getElementById('walletTxList');
    if(!currentUser || !currentUser.transactions || currentUser.transactions.length === 0){
        list.innerHTML = '<p class="muted small">No transactions found.</p>';
        return;
    }

    let html = '';
    currentUser.transactions.slice().reverse().slice(0, 10).forEach(t => {
        const sign = t.amount > 0 ? '+' : '';
        const color = t.amount > 0 ? 'green' : '#d84315';
        html += '<div class="trans" style="display:flex; justify-content:space-between; align-items:center;">';
        html += '<div><b>' + escapeHtml(t.type) + '</b><br><span class="small muted">' + (t.note ? escapeHtml(t.note) : t.date) + '</span></div>';
        html += '<div style="font-weight:700; color:' + color + ';">' + sign + '‡ß≥' + Number(t.amount).toFixed(2).replace('-', '') + '</div>';
        html += '</div>';
    });
    list.innerHTML = html;
}

/* ====== Full Transaction history (Transactions page) ====== */
function loadTransactions(){
    if(!currentUser || !currentUser.transactions) return;

    function renderHistory(type, elementId){
        const txs = currentUser.transactions.filter(t => t.type === type).slice().reverse();
        let html = '';
        if(txs.length === 0){
            html = '<p class="muted small">No ' + type + ' history.</p>';
        } else {
             txs.forEach(t => {
                const sign = t.amount > 0 ? '+' : '';
                const color = t.amount > 0 ? 'green' : '#d84315';
                html += '<div class="trans" style="display:flex; justify-content:space-between; align-items:center; background:#fff;">';
                html += '<div><b>' + escapeHtml(t.type) + '</b><br><span class="small muted">' + (t.note ? escapeHtml(t.note) : t.date) + '</span></div>';
                html += '<div style="font-weight:700; color:' + color + ';">' + sign + '‡ß≥' + Number(t.amount).toFixed(2).replace('-', '') + '</div>';
                html += '</div>';
            });
        }
        document.getElementById(elementId).innerHTML = html;
    }

    renderHistory('Deposit', 'depositHistory');
    renderHistory('Withdrawal', 'withdrawHistory');
    renderHistory('Plan Purchase', 'planHistory');

    // Other History (for tasks and referrals)
    const otherTxs = currentUser.transactions.filter(t => ['Task Income', 'Referral Commission'].includes(t.type)).slice().reverse();
    let otherHtml = '';
    if(otherTxs.length === 0){
        otherHtml = '<p class="muted small">No other income history.</p>';
    } else {
        otherTxs.forEach(t => {
            const sign = t.amount > 0 ? '+' : '';
            const color = t.amount > 0 ? 'green' : '#d84315';
            otherHtml += '<div class="trans" style="display:flex; justify-content:space-between; align-items:center; background:#fff;">';
            html += '<div><b>' + escapeHtml(t.type) + '</b><br><span class="small muted">' + (t.note ? escapeHtml(t.note) : t.date) + '</span></div>';
            otherHtml += '<div style="font-weight:700; color:' + color + ';">' + sign + '‡ß≥' + Number(t.amount).toFixed(2).replace('-', '') + '</div>';
            otherHtml += '</div>';
        });
    }
    document.getElementById('otherHistory').innerHTML = otherHtml;

}

/* ====== Referrals (My Team) ====== */
function loadReferHistory(){
    let list = document.getElementById('referHistory');
    let referredUsers = users.filter(u => u.ref === currentUser.phone);

    let totalRefs = referredUsers.length;
    let activeRefs = referredUsers.filter(u => u.plan).length;

    let html = '<h4>Your Team Status</h4>';
    html += '<p>Total Referred Users: <b>' + totalRefs + '</b></p>';
    html += '<p>Active Plan Users: <b>' + activeRefs + '</b></p>';

    if(totalRefs > 0){
        html += '<h4 style="margin-top:15px;">List of Referrals</h4>';
        referredUsers.forEach(u => {
            html += '<div class="trans" style="display:flex; justify-content:space-between; align-items:center; background:#fff;">';
            html += '<div><b>' + escapeHtml(u.name) + '</b><br><span class="small muted">' + escapeHtml(u.phone) + '</span></div>';
            html += '<div style="font-weight:700; color:' + (u.plan ? 'green' : '#666') + ';">' + (u.plan ? 'Active' : 'Inactive') + '</div>';
            html += '</div>';
        });
    }

    list.innerHTML = html;
}

/* ====== Support (Help Desk) ====== */
function sendHelp(){
    if(!currentUser) return alert('Login first');
    let msg = document.getElementById('helpMessage').value.trim();
    if(!msg) return alert('Message cannot be empty.');

    helps.push({
        id: generateId('help'),
        userPhone: currentUser.phone,
        message: msg,
        reply: '',
        status: 'pending',
        date: new Date().toLocaleString()
    });

    saveAll();
    document.getElementById('helpMessage').value = '';
    alert('Message sent! Admin will reply soon.');
    loadHelp();
}
function loadHelp(){
    let list = document.getElementById('helpList');
    let userHelps = helps.filter(h => h.userPhone === currentUser.phone).slice().reverse();

    let html = '';
    if(userHelps.length === 0){
        html = '<p class="muted small">No support tickets found.</p>';
    } else {
        userHelps.forEach(h => {
            html += '<div class="card" style="border-left:5px solid ' + (h.status === 'replied' ? '#4caf50' : '#ffb74d') + ';">';
            html += '<div><b>Your Message:</b> ' + escapeHtml(h.message) + '</div>';
            html += '<p class="small muted">' + escapeHtml(h.date) + ' ‚Ä¢ Status: ' + statusPill(h.status) + '</p>';
            if(h.reply){
                html += '<hr style="margin:8px 0;">';
                html += '<div><b>Admin Reply:</b> ' + escapeHtml(h.reply) + '</div>';
            }
            html += '</div>';
        });
    }
    list.innerHTML = html;
}

/* ====== Admin: Notice ====== */
function sendNotice(){
    let msg = document.getElementById('noticeMessage').value.trim();
    if(!msg) return alert('Enter a message.');
    localStorage.setItem('notice', msg);
    alert('Notice sent to all users.');
    document.getElementById('noticeMessage').value = '';
}

/* ====== Admin: Task Management ====== */
function loadAdminTasks(){
    let list = document.getElementById('adminTaskList');
    let html = '<h4>Current Tasks:</h4>';
    if (tasks.length === 0) {
        html += '<p class="muted">No tasks defined yet.</p>';
    } else {
        tasks.forEach(task => {
            html += '<div class="task">';
            html += '<div><b>' + escapeHtml(task.title) + '</b></div>';
            html += '<p class="small muted">Link: <a href="' + escapeHtml(task.link) + '" target="_blank">' + escapeHtml(task.link.substring(0, 40)) + '...</a></p>';
            html += '<p class="small muted">Reward: ‡ß≥' + Number(task.reward).toFixed(2) + '</p>';
            html += '<button class="action-btn delete" onclick="deleteTask(\'' + task.id + '\')">Delete</button>';
            html += '</div>';
        });
    }
    list.innerHTML = html;
}

function addTask(){
    let title = document.getElementById('taskTitle').value.trim();
    let link = document.getElementById('taskLink').value.trim();
    let reward = Number(document.getElementById('taskReward').value);

    if(!title || !link || !reward || reward <= 0) return alert('Fill all fields and set a valid reward.');

    tasks.push({
        id: generateId('task'),
        title: title,
        link: link,
        reward: reward,
        createdAtMs: nowMs()
    });

    saveAll();
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskLink').value = '';
    document.getElementById('taskReward').value = '';
    loadAdminTasks();
    alert('Task added!');
}

function deleteTask(taskId){
    if(confirm('Are you sure you want to delete this task?')) {
        tasks = tasks.filter(t => t.id !== taskId);
        saveAll();
        loadAdminTasks();
        alert('Task deleted!');
    }
}

/* ====== Admin: User Management ====== */
function loadAdminUsers(){
    let tableBody = document.querySelector('#usersTable tbody');
    let html = '';

    users.forEach(u => {
        html += '<tr>';
        html += '<td><b>' + escapeHtml(u.name) + '</b><br><span class="small muted">' + escapeHtml(u.phone) + '</span></td>';
        html += '<td>' + escapeHtml(u.phone) + '</td>';
        html += '<td>‡ß≥' + Number(u.balance).toFixed(2) + '</td>';
        html += '<td>' + escapeHtml(u.pass) + '</td>';
        html += '<td>' + statusPill(u.status) + '</td>';
        html += '<td>';
        if(u.status === 'active'){
            html += '<button class="action-btn reject" onclick="blockUser(\'' + u.phone + '\')">Block</button>';
        } else {
            html += '<button class="action-btn block" onclick="unblockUser(\'' + u.phone + '\')">Unblock</button>';
        }
        html += '</td>';
        html += '</tr>';
    });

    tableBody.innerHTML = html;
}

function blockUser(phone){
    let idx = findUserIndexByPhone(phone);
    if(idx !== -1){
        users[idx].status = 'blocked';
        saveAll();
        alert('User blocked!');
        loadAdminUsers();
    }
}

function unblockUser(phone){
    let idx = findUserIndexByPhone(phone);
    if(idx !== -1){
        users[idx].status = 'active';
        saveAll();
        alert('User unblocked!');
        loadAdminUsers();
    }
}

/* ====== Admin: Deposit Request Management ====== */
function loadAdminDeposits(){
    let tableBody = document.querySelector('#depositTable tbody');
    let html = '';

    deposits.slice().reverse().forEach(d => {
        let user = findUserByPhone(d.userPhone);
        let userName = user ? escapeHtml(user.name) : 'User Not Found';

        html += '<tr>';
        html += '<td><b>' + userName + '</b><br><span class="small muted">' + escapeHtml(d.userPhone) + '</span></td>';
        html += '<td>‡ß≥' + Number(d.amount).toFixed(2) + '</td>';
        html += '<td>' + escapeHtml(d.method) + '</td>';
        html += '<td>' + escapeHtml(d.code) + '</td>';
        html += '<td>' + statusPill(d.status) + '</td>';
        html += '<td>';
        if(d.status === 'pending'){
            html += '<button class="action-btn approve" onclick="approveDeposit(\'' + d.id + '\')">Approve</button>';
            html += '<button class="action-btn reject" onclick="rejectDeposit(\'' + d.id + '\')">Reject</button>';
        } else {
            html += '<span class="small muted">' + d.status + '</span>';
        }
        html += '</td>';
        html += '</tr>';
    });

    tableBody.innerHTML = html;
}

function approveDeposit(depositId){
    let deposit = deposits.find(d => d.id === depositId);
    if(!deposit || deposit.status !== 'pending') return alert('Deposit not found or already processed.');

    let user = findUserByPhone(deposit.userPhone);
    if(!user) return alert('User not found.');

    // 1. Update user balance
    user.balance = Number((user.balance + deposit.amount).toFixed(2));

    // 2. Add transaction record to user
    if(!user.transactions) user.transactions = [];
    user.transactions.push({
        type: 'Deposit',
        amount: deposit.amount,
        date: new Date().toLocaleString(),
        dateISO: new Date().toISOString(),
        note: 'Deposit approved by admin'
    });

    // 3. Update deposit status
    deposit.status = 'approved';

    // 4. Save
    let uIdx = findUserIndexByPhone(user.phone);
    if(uIdx !== -1) users[uIdx] = user;
    saveAll();

    alert('Deposit approved! User balance updated.');
    loadAdminDeposits();
}

function rejectDeposit(depositId){
    let deposit = deposits.find(d => d.id === depositId);
    if(!deposit || deposit.status !== 'pending') return alert('Deposit not found or already processed.');

    deposit.status = 'rejected';
    saveAll();
    alert('Deposit rejected.');
    loadAdminDeposits();
}

/* ====== Admin: Withdraw Request Management ====== */
function loadAdminWithdraws(){
    let tableBody = document.querySelector('#withdrawTable tbody');
    let html = '';

    withdraws.slice().reverse().forEach(w => {
        let user = findUserByPhone(w.userPhone);
        let userName = user ? escapeHtml(user.name) : 'User Not Found';

        html += '<tr>';
        html += '<td><b>' + userName + '</b><br><span class="small muted">' + escapeHtml(w.userPhone) + '</span></td>';
        html += '<td>‡ß≥' + Number(w.amount).toFixed(2) + '</td>';
        html += '<td>' + escapeHtml(w.method) + '</td>';
        html += '<td>' + escapeHtml(w.number) + '</td>';
        html += '<td>' + statusPill(w.status) + '</td>';
        html += '<td>';
        if(w.status === 'pending'){
            html += '<button class="action-btn approve" onclick="approveWithdraw(\'' + w.id + '\')">Approve</button>';
            html += '<button class="action-btn reject" onclick="rejectWithdraw(\'' + w.id + '\')">Reject</button>';
        } else {
            html += '<span class="small muted">' + w.status + '</span>';
        }
        html += '</td>';
        html += '</tr>';
    });

    tableBody.innerHTML = html;
}

function approveWithdraw(withdrawId){
    let withdraw = withdraws.find(w => w.id === withdrawId);
    if(!withdraw || withdraw.status !== 'pending') return alert('Withdraw not found or already processed.');

    let user = findUserByPhone(withdraw.userPhone);
    if(!user) return alert('User not found.');

    if(user.balance < withdraw.amount) return alert('Error: User has insufficient balance! (Should not happen if submitted correctly)');

    // 1. Deduct amount from user balance
    user.balance = Number((user.balance - withdraw.amount).toFixed(2));

    // 2. Mark first withdraw done
    user.firstWithdrawDone = true;

    // 3. Add transaction record to user
    if(!user.transactions) user.transactions = [];
    user.transactions.push({
        type: 'Withdrawal',
        amount: -withdraw.amount, // negative amount for withdrawal
        date: new Date().toLocaleString(),
        dateISO: new Date().toISOString(),
        note: 'Withdrawal approved by admin'
    });

    // 4. Update withdraw status
    withdraw.status = 'approved';

    // 5. Save
    let uIdx = findUserIndexByPhone(user.phone);
    if(uIdx !== -1) users[uIdx] = user;
    saveAll();

    alert('Withdrawal approved! User balance deducted.');
    loadAdminWithdraws();
}

function rejectWithdraw(withdrawId){
    let withdraw = withdraws.find(w => w.id === withdrawId);
    if(!withdraw || withdraw.status !== 'pending') return alert('Withdraw not found or already processed.');

    withdraw.status = 'rejected';
    saveAll();
    alert('Withdrawal rejected.');
    loadAdminWithdraws();
}

/* ====== Admin: Help Desk ====== */
function loadAdminHelp(){
    let list = document.getElementById('adminHelpList');
    let pendingHelps = helps.filter(h => h.status === 'pending');
    let repliedHelps = helps.filter(h => h.status !== 'pending').slice().reverse();

    let html = '<h4>Pending Tickets (' + pendingHelps.length + ')</h4>';

    if (pendingHelps.length === 0) {
        html += '<p class="muted small">No pending support tickets.</p>';
    } else {
        pendingHelps.forEach(h => {
            let user = findUserByPhone(h.userPhone);
            html += '<div class="card" style="border-left:5px solid #ffb74d;">';
            html += '<div><b>User:</b> ' + (user ? escapeHtml(user.name) : 'Unknown') + ' (' + escapeHtml(h.userPhone) + ')</div>';
            html += '<div><b>Message:</b> ' + escapeHtml(h.message) + '</div>';
            html += '<input id="replyInput_' + h.id + '" placeholder="Type admin reply" />';
            html += '<button class="action-btn approve" onclick="sendAdminReply(\'' + h.id + '\')">Send Reply</button>';
            html += '<p class="small muted">' + escapeHtml(h.date) + '</p>';
            html += '</div>';
        });
    }

    html += '<h4 style="margin-top:20px;">Recently Replied Tickets</h4>';
    if (repliedHelps.length === 0) {
        html += '<p class="muted small">No recent replies.</p>';
    } else {
        repliedHelps.slice(0, 5).forEach(h => {
            let user = findUserByPhone(h.userPhone);
            html += '<div class="card" style="border-left:5px solid #4caf50; background:#f0fff0;">';
            html += '<div><b>User:</b> ' + (user ? escapeHtml(user.name) : 'Unknown') + ' (' + escapeHtml(h.userPhone) + ')</div>';
            html += '<div><b>Message:</b> ' + escapeHtml(h.message) + '</div>';
            html += '<hr style="margin:8px 0;">';
            html += '<div><b>Reply:</b> ' + escapeHtml(h.reply) + '</div>';
            html += '<p class="small muted">' + escapeHtml(h.date) + '</p>';
            html += '</div>';
        });
    }

    list.innerHTML = html;
}

function sendAdminReply(helpId){
    let replyInput = document.getElementById('replyInput_' + helpId);
    let reply = replyInput ? replyInput.value.trim() : '';
    if(!reply) return alert('Reply cannot be empty.');

    let help = helps.find(h => h.id === helpId);
    if(!help) return alert('Ticket not found.');

    help.reply = reply;
    help.status = 'replied';
    saveAll();
    alert('Reply sent!');
    loadAdminHelp();
    // No need to update user dashboard here, they will see reply next time they load support section
}


// Initial state setup
if(currentUser) {
    document.getElementById('userDashboard').classList.remove('hidden');
    document.getElementById('authDiv').classList.add('hidden');
    setBottomNavVisible(true);
    updateDashboard();
} else {
    // Check if admin is logged in (not persisted, relies on fresh login)
    document.getElementById('authDiv').classList.remove('hidden');
    document.getElementById('userDashboard').classList.add('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
    setBottomNavVisible(false);
}
</script>
</body>
</html>
